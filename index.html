<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Lumen Studio – IA Criativa</title>
  <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@700;400&family=Inter:wght@400;600&display=swap" rel="stylesheet">
  <style>
    :root {
      --primary: #6a11cb;
      --secondary: #2575fc;
      --accent: #ff6b6b;
      --glass-bg: rgba(255,255,255,0.10);
      --background-dark: linear-gradient(135deg, #191c22 0%, #23272f 100%);
      --text-dark: #fff;
      --option-bg-dark: rgba(60,65,80,0.18);
      --option-selected-dark: rgba(110,110,130,0.32);
      --border-dark: rgba(100,100,120,0.28);
      --input-bg-dark: #242733;
      --input-text-dark: #f7f8fa;
      --card-bg-dark: rgba(36,38,45,0.98);
      --shadow-dark: 0 5px 25px 0 rgba(30,35,45,0.22);
    }
    body {
      font-family: 'Inter', 'Montserrat', Arial, sans-serif;
      background: var(--background-dark);
      color: var(--text-dark);
      min-height: 100vh;
      line-height: 1.6;
      transition: background 0.4s, color 0.32s;
    }
    header {
      width: 100%;
      padding: 38px 0 18px 0;
      text-align: center;
      position: relative;
    }
    .logo {
      font-family: 'Montserrat', sans-serif;
      font-size: 2.4rem;
      font-weight: 800;
      letter-spacing: 1px;
      background: linear-gradient(90deg,#ff8a00,#da1b60 80%);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      text-shadow: 0 2px 10px rgba(0,0,0,0.10);
      margin-bottom: 8px;
    }
    .theme-toggle {
      position: absolute;
      top: 22px;
      right: 22px;
      background: var(--card-bg-dark);
      border: 1px solid var(--border-dark);
      border-radius: 50%;
      width: 44px;
      height: 44px;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      font-size: 1.32rem;
      color: var(--text-dark);
      box-shadow: var(--shadow-dark);
      transition: background .22s, color .22s, border .22s;
      z-index: 20;
    }
    nav {
      margin-top: 10px;
    }
    nav a {
      color: #fff;
      text-decoration: none;
      margin: 0 13px;
      font-weight: 600;
      opacity: 0.86;
      transition: color .2s;
    }
    nav a:hover {
      color: var(--accent);
    }
    .main-hero {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      min-height: 55vh;
      text-align: center;
      padding-bottom: 20px;
    }
    .main-title {
      font-family: 'Montserrat', sans-serif;
      font-size: 2.2rem;
      font-weight: 700;
      margin-bottom: 10px;
      background: linear-gradient(90deg,#ff8a00,#da1b60 80%);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      text-shadow: 0 2px 10px rgba(0,0,0,0.10);
    }
    .main-desc {
      font-size: 1.13rem;
      margin-bottom: 26px;
      color: var(--text-dark);
      opacity: 0.94;
      max-width: 520px;
    }
    .options-panel {
      display: flex;
      justify-content: center;
      gap: 22px;
      flex-wrap: wrap;
      margin-bottom: 20px;
    }
    .option-card {
      background: var(--option-bg-dark);
      border-radius: 18px;
      box-shadow: var(--shadow-dark);
      border: 1.2px solid var(--border-dark);
      min-width: 230px;
      max-width: 280px;
      padding: 34px 20px 32px 20px;
      text-align: center;
      cursor: pointer;
      transition: transform .18s, box-shadow .18s, background .22s, border .18s;
      position: relative;
      color: var(--text-dark);
    }
    .option-card.selected,
    .option-card:hover {
      transform: translateY(-6px) scale(1.04);
      box-shadow: 0 14px 36px 0 rgba(31,38,135,0.22);
      border-color: var(--accent);
      background: var(--option-selected-dark);
    }
    .option-icon {
      font-size: 2.8rem;
      margin-bottom: 18px;
      display: block;
    }
    .option-title {
      font-size: 1.2rem;
      font-family: 'Montserrat', sans-serif;
      font-weight: 700;
      margin-bottom: 8px;
    }
    .option-desc {
      font-size: 0.99rem;
      color: var(--text-dark);
      opacity: 0.80;
      min-height: 36px;
    }
    .section-module {
      max-width: 650px;
      margin: 34px auto 0 auto;
      background: var(--card-bg-dark);
      border-radius: 22px;
      box-shadow: var(--shadow-dark);
      border: 1.2px solid var(--border-dark);
      padding: 32px 20px 30px 20px;
      display: none;
      animation: fadeIn .6s;
    }
    .section-module.active { display: block; }
    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(30px);}
      to { opacity: 1; transform: translateY(0);}
    }
    .input-group { margin-bottom: 25px; }
    label {
      display: block;
      margin-bottom: 8px;
      font-weight: 500;
      font-size: 1.08rem;
    }
    textarea {
      width: 100%;
      height: 120px;
      padding: 13px;
      border-radius: 10px;
      border: none;
      font-size: 1rem;
      background: var(--input-bg-dark);
      resize: vertical;
      color: var(--input-text-dark);
    }
    .voice-options {
      display: flex;
      flex-wrap: wrap;
      gap: 13px;
      margin-top: 13px;
    }
    .voice-option {
      flex: 1;
      min-width: 100px;
      background: var(--option-bg-dark);
      padding: 13px;
      border-radius: 10px;
      cursor: pointer;
      transition: all 0.3s ease;
      border: 2px solid transparent;
      text-align: left;
      color: var(--text-dark);
    }
    .voice-option:hover {
      background: var(--option-selected-dark);
    }
    .voice-option.selected {
      background: var(--option-selected-dark);
      border-color: var(--accent);
    }
    .voice-name {
      font-weight: 600;
      margin-bottom: 4px;
      color: var(--text-dark);
    }
    .voice-desc {
      font-size: 0.88rem;
      opacity: 0.84;
      color: var(--text-dark);
    }
    .custom-controls {
      display: flex;
      flex-wrap: wrap;
      gap: 20px;
      align-items: center;
      margin-bottom: 18px;
      margin-top: 10px;
      justify-content: flex-start;
    }
    .custom-control {
      display: flex;
      align-items: center;
      gap: 7px;
      font-size: 1rem;
      color: var(--text-dark);
      background: rgba(80,80,90,0.10);
      border-radius: 8px;
      padding: 7px 16px 7px 10px;
    }
    .custom-control label {
      margin: 0 0 0 2px;
      font-size: 1rem;
      font-weight: 400;
      color: inherit;
      display: inline;
    }
    .custom-control input[type="range"] {
      width: 80px;
      margin-left: 7px;
      margin-right: 7px;
    }
    .custom-control input[type="number"] {
      width: 70px;
      margin-left: 7px;
    }
    .custom-control .speed-suggestion {
      margin-left: 12px;
      opacity: 0.8;
      font-size: 0.95em;
      color: var(--accent);
    }
    button {
      background: white;
      color: var(--secondary);
      border: none;
      padding: 13px 28px;
      font-size: 1.1rem;
      font-weight: 600;
      border-radius: 50px;
      cursor: pointer;
      width: 100%;
      transition: all 0.3s ease;
      box-shadow: 0 4px 20px rgba(0,0,0,0.11);
      margin-top: 3px;
    }
    button:hover {
      transform: translateY(-2px);
      box-shadow: 0 6px 25px rgba(0,0,0,0.18);
    }
    button:disabled {
      background: #cccccc;
      cursor: not-allowed;
      transform: none;
      box-shadow: none;
    }
    .api-key-trigger {
      display: inline-block;
      margin: 18px auto 0 auto;
      background: none;
      border: none;
      color: var(--accent);
      font-weight: bold;
      font-size: 1.08rem;
      text-decoration: underline;
      cursor: pointer;
      transition: color 0.22s;
    }
    .api-key-trigger:hover { color: #ff3b3b; }
    .api-key-modal-bg {
      display: none;
      position: fixed;
      top:0; left:0; width:100vw; height:100vh;
      background: rgba(15,18,30,0.88);
      z-index: 9999;
      align-items: center;
      justify-content: center;
    }
    .api-key-modal-bg.active { display: flex; }
    .api-key-modal {
      background: var(--card-bg-dark);
      border-radius: 15px;
      padding: 30px 22px 22px 22px;
      max-width: 340px;
      width: 94vw;
      box-shadow: 0 5px 38px 0 rgba(20,20,30,0.16);
      position: relative;
      text-align: left;
      color: var(--text-dark);
      border: 1.2px solid var(--border-dark);
      animation: fadeIn .3s;
    }
    .api-key-modal h3 {
      margin-top: 0;
      margin-bottom: 15px;
      font-size: 1.1rem;
      font-weight: 700;
    }
    .api-key-modal label {
      margin-bottom: 6px;
      font-size: 1rem;
    }
    .api-key-modal input[type="password"],
    .api-key-modal input[type="text"] {
      width: 100%;
      padding: 9px 38px 9px 12px;
      border-radius: 7px;
      border: none;
      background: var(--input-bg-dark);
      color: var(--input-text-dark);
      font-size: 1rem;
      letter-spacing: 0.08em;
      margin-bottom: 12px;
    }
    .api-key-modal .show-hide-btn {
      position: absolute;
      right: 25px;
      top: 86px;
      background: none;
      border: none;
      color: var(--input-text-dark);
      font-size: 1.2em;
      cursor: pointer;
      z-index: 2;
      padding: 0 7px;
    }
    .api-key-modal .close-modal {
      position: absolute;
      top: 10px; right: 15px;
      background: none;
      border: none;
      color: var(--accent);
      font-size: 1.6rem;
      font-weight: bold;
      cursor: pointer;
      z-index: 10;
      transition: color .2s;
    }
    .api-key-modal .close-modal:hover { color: #ff3b3b; }
    .api-key-modal small {
      font-size: 0.82rem;
      opacity: 0.7;
    }
    .api-key-modal a { color: var(--accent); text-decoration: underline; }
    #audio-container {
      margin-top: 20px;
      text-align: center;
    }
    #audio-player {
      width: 100%;
      margin-top: 17px;
      border-radius: 9px;
    }
    .download-btn {
      display: inline-block;
      background: #4CAF50;
      color: white;
      padding: 11px 20px;
      border-radius: 50px;
      text-decoration: none;
      font-weight: 600;
      margin-top: 18px;
      transition: all 0.3s ease;
    }
    .download-btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 15px rgba(0,0,0,0.19);
    }
    #download-with-effect {
      background: #7B1FA2;
    }
    #download-with-effect:hover {
      background: #a24cf3;
    }
    #play-with-effect {
      background: #03a9f4;
      color: #fff;
      margin-top: 12px;
      border: none;
    }
    #play-with-effect:hover {
      background: #0288d1;
    }
    .hidden { display: none; }
    .loader {
      display: inline-block;
      width: 34px;
      height: 34px;
      border: 4px solid rgba(255,255,255,0.3);
      border-radius: 50%;
      border-top-color: white;
      animation: spin 1s linear infinite;
      margin-bottom: 12px;
    }
    @keyframes spin { to { transform: rotate(360deg); } }
    #loading {
      text-align: center;
      margin: 18px 0;
      display: none;
    }
    #error-message {
      color: #ff6b6b;
      background: rgba(0, 0, 0, 0.15);
      padding: 12px;
      border-radius: 6px;
      margin-top: 11px;
      display: none;
    }
    .coming-soon {
      font-size: 1.15rem;
      color: var(--text-dark);
      opacity: 0.94;
      text-align: center;
      padding: 28px 0 24px 0;
    }
    /* Barra de progresso */
    #progress-bar-container {
      width:100%;
      margin-bottom:12px;
      position:relative;
      height:20px;
      margin-top:8px;
    }
    #progress-bar-bg {
      background:#333;
      border-radius:14px;
      width:100%;
      height:20px;
      overflow:hidden;
      position:relative;
    }
    #progress-bar-fill {
      background:linear-gradient(90deg,#43e97b 0%,#38f9d7 100%);
      width:0%;
      height:100%;
      transition:width 0.3s;
    }
    #progress-bar-label {
      position:absolute;
      top:0;
      left:0;
      width:100%;
      text-align:center;
      color:#fff;
      font-size:0.95em;
      font-weight:bold;
      text-shadow:0 1px 2px #000;
      line-height:20px;
      pointer-events:none;
    }
    footer {
      text-align: center;
      margin-top: 60px;
      opacity: 0.7;
      font-size: 0.98rem;
      padding-bottom: 28px;
    }
    @media (max-width: 900px) {
      .options-panel { flex-direction: column; align-items: center; }
      .custom-controls { flex-direction: column; align-items: stretch; gap: 10px; }
    }
    @media (max-width: 600px) {
      .main-title { font-size: 1.37rem;}
      .section-module { padding: 14px 3px; }
      .logo { font-size: 1.5rem;}
      .theme-toggle { top: 12px; right: 10px; }
    }
  </style>
</head>
<body>
  <header>
    <div class="logo">Lumen Studio</div>
    <button class="theme-toggle" id="theme-toggle" aria-label="Alternar tema">
      <span id="theme-icon">🌙</span>
    </button>
    <nav>
      <a href="#tts">Texto para Áudio</a>
      <a href="#img">Texto para Imagem</a>
      <a href="#vid">Texto para Vídeo</a>
    </nav>
  </header>

  <main>
    <section class="main-hero">
      <div class="main-title">Sua Central Criativa com IA</div>
      <div class="main-desc">Transforme texto em áudio, imagem e vídeo de forma simples, rápida e profissional. Escolha o que quer criar:</div>
      <div class="options-panel">
        <div class="option-card selected" id="opt-tts">
          <span class="option-icon">🔊</span>
          <div class="option-title">Texto para Áudio</div>
          <div class="option-desc">Converta textos em vozes realistas e premium.</div>
        </div>
        <div class="option-card" id="opt-img">
          <span class="option-icon">🖼️</span>
          <div class="option-title">Texto para Imagem</div>
          <div class="option-desc">Gere imagens únicas a partir de descrições.</div>
        </div>
        <div class="option-card" id="opt-vid">
          <span class="option-icon">🎬</span>
          <div class="option-title">Texto para Vídeo</div>
          <div class="option-desc">Transforme roteiros em vídeos automaticamente.</div>
        </div>
      </div>
    </section>

    <!-- Texto para Áudio -->
    <section class="section-module active" id="module-tts">
      <h2 style="text-align:center; font-size:1.25rem; margin-bottom:22px;">Texto para Áudio (TTS)</h2>
      <div class="input-group">
        <label for="text-input">Digite seu texto:</label>
        <textarea id="text-input" placeholder="Escreva aqui o texto que deseja converter em voz...">Olá! Esta é uma demonstração do sistema de texto para voz com vozes premium.</textarea>
      </div>
      <div class="input-group">
        <label>Selecione a voz:</label>
        <div class="voice-options">
          <div class="voice-option selected" data-voice="EXAVITQu4vr4xnSDxMaL">
            <div class="voice-name">Bianca (BR)</div>
            <div class="voice-desc">Voz feminina natural</div>
          </div>
          <div class="voice-option" data-voice="VR6AewLTigWG4xSOukaG">
            <div class="voice-name">Antônio (BR)</div>
            <div class="voice-desc">Voz masculina clara</div>
          </div>
          <div class="voice-option" data-voice="MF3mGyEYCl7XYWbV9V6O">
            <div class="voice-name">Lúcia (PT)</div>
            <div class="voice-desc">Sotaque português</div>
          </div>
          <div class="voice-option" data-voice="Wa8JcdAKK7NzSC0jv3Bs">
            <div class="voice-name">Minha Voz</div>
            <div class="voice-desc">Voz personalizada ElevenLabs</div>
          </div>
        </div>
      </div>
      <!-- Customização de voz -->
      <div class="custom-controls">
        <div class="custom-control">
          <input type="checkbox" id="reverb">
          <label for="reverb">Reverb</label>
        </div>
        <div class="custom-control">
          <label for="desired-duration">Duração desejada (segundos):</label>
          <input type="number" min="5" max="300" step="1" id="desired-duration" placeholder="ex: 50">
        </div>
        <div class="custom-control">
          <label for="speed">Velocidade:</label>
          <input type="range" min="0.7" max="2.0" step="0.01" value="1" id="speed" />
          <span id="speed-value">1.00x</span>
          <span class="speed-suggestion" id="speed-suggestion"></span>
        </div>
      </div>
      <button id="generate-btn">Gerar Áudio</button>
      <button class="api-key-trigger" id="open-apikey-btn">Mostrar chave API</button>
      <div id="loading" class="hidden">
        <div class="loader"></div>
        <p>Processando seu áudio...</p>
      </div>
      <div id="error-message" class="hidden"></div>
      <div class="card hidden" id="result-card" style="background:none; box-shadow:none; border:none; margin:0;">
        <h3 style="text-align:center;">Resultado</h3>
        <!-- Barra de progresso -->
        <div id="progress-bar-container" class="hidden">
          <div id="progress-bar-bg">
            <div id="progress-bar-fill"></div>
          </div>
          <div id="progress-bar-label">0%</div>
        </div>
        <div id="audio-container">
          <audio id="audio-player" controls></audio>
          <a id="download-btn" class="download-btn hidden">⬇️ Baixar Áudio</a>
          <a id="download-with-effect" class="download-btn hidden" style="background:#7B1FA2;">⬇️ Baixar com efeito</a>
          <button id="play-with-effect" class="download-btn hidden" style="background:#03a9f4; color:#fff; margin-top:12px;">▶️ Reproduzir com efeito</button>
        </div>
      </div>
    </section>

    <!-- Modal da chave API -->
    <div class="api-key-modal-bg" id="apikey-modal-bg">
      <div class="api-key-modal">
        <button class="close-modal" id="close-apikey-modal" title="Fechar">&times;</button>
        <h3>Chave API ElevenLabs</h3>
        <label for="api-key">Chave API:</label>
        <input type="password" id="api-key" placeholder="Cole sua chave API aqui" autocomplete="off">
        <button class="show-hide-btn" id="toggle-api-key" title="Mostrar/ocultar chave" tabindex="0">
          <span id="eye-icon">&#128065;</span>
        </button>
        <small>
          Obtenha sua chave gratuita em <a href="https://elevenlabs.io/" target="_blank">elevenlabs.io</a>
        </small>
      </div>
    </div>

    <!-- Texto para Imagem -->
    <section class="section-module" id="module-img">
      <h2 style="text-align:center; font-size:1.18rem;">Texto para Imagem</h2>
      <div class="coming-soon">Em breve: gere imagens incríveis a partir de qualquer descrição!</div>
    </section>

    <!-- Texto para Vídeo -->
    <section class="section-module" id="module-vid">
      <h2 style="text-align:center; font-size:1.18rem;">Texto para Vídeo</h2>
      <div class="coming-soon">Em breve: transforme roteiros em vídeos automaticamente!</div>
    </section>
  </main>

  <footer>
    Desenvolvido com ❤️ por Lumen Studio – Powered by ElevenLabs.
  </footer>
  <script>
    // Alternância de módulos
    const optionCards = {
      tts: document.getElementById('opt-tts'),
      img: document.getElementById('opt-img'),
      vid: document.getElementById('opt-vid')
    };
    const modules = {
      tts: document.getElementById('module-tts'),
      img: document.getElementById('module-img'),
      vid: document.getElementById('module-vid')
    };
    function selectModule(key) {
      Object.keys(optionCards).forEach(k => {
        optionCards[k].classList.toggle('selected', k === key);
        modules[k].classList.toggle('active', k === key);
      });
    }
    optionCards.tts.onclick = () => selectModule('tts');
    optionCards.img.onclick = () => selectModule('img');
    optionCards.vid.onclick = () => selectModule('vid');

    // Modal da chave API
    const apikeyModalBg = document.getElementById('apikey-modal-bg');
    const openApikeyBtn = document.getElementById('open-apikey-btn');
    const closeApikeyModal = document.getElementById('close-apikey-modal');
    openApikeyBtn.onclick = () => {
      apikeyModalBg.classList.add('active');
      setTimeout(() => { document.getElementById('api-key').focus(); }, 100);
    };
    closeApikeyModal.onclick = () => apikeyModalBg.classList.remove('active');
    apikeyModalBg.onclick = (e) => {
      if (e.target === apikeyModalBg) apikeyModalBg.classList.remove('active');
    };

    // Carrega chave API do localStorage
    window.addEventListener('DOMContentLoaded', () => {
      const savedKey = localStorage.getItem('elevenlabs_api_key');
      if (savedKey) document.getElementById('api-key').value = savedKey;
    });
    document.getElementById('api-key').addEventListener('input', e => {
      localStorage.setItem('elevenlabs_api_key', e.target.value.trim());
    });

    // Mostrar/ocultar chave API
    const toggleApiKeyBtn = document.getElementById('toggle-api-key');
    const eyeIcon = document.getElementById('eye-icon');
    toggleApiKeyBtn.addEventListener('click', () => {
      const apiKeyInput = document.getElementById('api-key');
      if (apiKeyInput.type === "password") {
        apiKeyInput.type = "text";
        eyeIcon.textContent = "🙈";
      } else {
        apiKeyInput.type = "password";
        eyeIcon.textContent = "👁️";
      }
    });
    toggleApiKeyBtn.addEventListener('keydown', e => {
      if (e.key === "Enter" || e.key === " ") toggleApiKeyBtn.click();
    });

    // Custom controls
    const speedInput = document.getElementById('speed');
    const speedValue = document.getElementById('speed-value');
    const reverbInput = document.getElementById('reverb');
    const desiredDurationInput = document.getElementById('desired-duration');
    const textInput = document.getElementById('text-input');
    const speedSuggestion = document.getElementById('speed-suggestion');

    function updateSpeedValue() {
      speedValue.textContent = Number(speedInput.value).toFixed(2) + "x";
    }
    speedInput.oninput = updateSpeedValue;

    // Sugestão automática de velocidade conforme texto e duração desejada
    function suggestSpeed() {
      const text = textInput.value.trim();
      const desired = parseFloat(desiredDurationInput.value);
      // Média: 13 caracteres/segundo (aprox. 780 caracteres/minuto)
      const avgCharsPerSec = 13;
      if (!text || !desired || desired < 1) {
        speedSuggestion.textContent = '';
        return;
      }
      const estimatedDuration = text.length / avgCharsPerSec;
      let suggestedSpeed = estimatedDuration / desired;
      if (suggestedSpeed < 0.7) suggestedSpeed = 0.7;
      if (suggestedSpeed > 2.0) suggestedSpeed = 2.0;
      speedSuggestion.textContent = `(Sugestão: ${suggestedSpeed.toFixed(2)}x)`;
    }
    textInput.addEventListener('input', suggestSpeed);
    desiredDurationInput.addEventListener('input', suggestSpeed);

    // ----- Barra de Progresso -----
    const progressBarContainer = document.getElementById('progress-bar-container');
    const progressBarFill = document.getElementById('progress-bar-fill');
    const progressBarLabel = document.getElementById('progress-bar-label');
    function updateProgress(percent) {
      progressBarFill.style.width = percent + '%';
      progressBarLabel.textContent = percent + '%';
    }

    // ----- TTS Module Script -----
    let currentVoice = "EXAVITQu4vr4xnSDxMaL";
    let audioUrl = null;

    const generateBtn = document.getElementById('generate-btn');
    const audioPlayer = document.getElementById('audio-player');
    const downloadBtn = document.getElementById('download-btn');
    const downloadWithEffectBtn = document.getElementById('download-with-effect');
    const playWithEffectBtn = document.getElementById('play-with-effect');
    const resultCard = document.getElementById('result-card');
    const loadingElement = document.getElementById('loading');
    const errorMessage = document.getElementById('error-message');

    // Seleção de voz
    document.querySelectorAll('.voice-option').forEach(option => {
      option.addEventListener('click', () => {
        document.querySelectorAll('.voice-option').forEach(opt => opt.classList.remove('selected'));
        option.classList.add('selected');
        currentVoice = option.dataset.voice;
        errorMessage.classList.add('hidden');
      });
    });

    // Efeito de reverb (Web Audio API)
    let currentAudioContext, convolverNode;
    async function applyReverb(audioElement) {
      // Desconecta anteriores
      if (currentAudioContext) { currentAudioContext.close(); }

      const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
      currentAudioContext = audioCtx;
      const source = audioCtx.createMediaElementSource(audioElement);
      const convolver = audioCtx.createConvolver();
      convolverNode = convolver;

      // Impulse response de exemplo (pode trocar por outro IR)
      const irUrl = 'https://cdn.jsdelivr.net/gh/joeeyjunior/public-assets@main/impulse-small.wav';
      const response = await fetch(irUrl);
      const arrayBuffer = await response.arrayBuffer();
      const irBuffer = await audioCtx.decodeAudioData(arrayBuffer);

      convolver.buffer = irBuffer;
      source.connect(convolver);
      convolver.connect(audioCtx.destination);
    }

    function removeReverb(audioElement) {
      if (currentAudioContext) {
        currentAudioContext.close();
        currentAudioContext = null;
        convolverNode = null;
        try {
          audioElement.srcObject = null;
        } catch(e){}
      }
    }

    // Função para mostrar botões de efeito ao finalizar
    function showEffectButtons() {
      downloadWithEffectBtn.classList.remove('hidden');
      playWithEffectBtn.classList.remove('hidden');
    }

    generateBtn.addEventListener('click', async () => {
      const text = textInput.value.trim();
      const apiKey = document.getElementById('api-key').value.trim();

      if (!text) {
        showError('Por favor, digite algum texto!');
        return;
      }
      if (!apiKey) {
        showError('Por favor, insira sua chave API do ElevenLabs!');
        return;
      }

      generateBtn.disabled = true;
      loadingElement.classList.remove('hidden');
      resultCard.classList.add('hidden');
      errorMessage.classList.add('hidden');
      downloadBtn.classList.add('hidden');
      downloadWithEffectBtn.classList.add('hidden');
      playWithEffectBtn.classList.add('hidden');
      progressBarContainer.classList.remove('hidden');
      updateProgress(5);
      let fakeProgress = 5;
      let fakeProgressInterval = setInterval(() => {
        if (fakeProgress < 95) {
          fakeProgress += Math.random() * 8;
          updateProgress(Math.min(95, Math.round(fakeProgress)));
        }
      }, 350);

      try {
        const response = await fetch(`https://api.elevenlabs.io/v1/text-to-speech/${currentVoice}`, {
          method: 'POST',
          headers: {
            'Accept': 'audio/mpeg',
            'Content-Type': 'application/json',
            'xi-api-key': apiKey
          },
          body: JSON.stringify({
            text: text,
            voice_settings: {
              stability: 0.5,
              similarity_boost: 0.8
            }
          })
        });

        if (!response.ok) {
          let errorMsg = `Erro na API: ${response.status} ${response.statusText}`;
          try {
            const errorData = await response.json();
            errorMsg = errorData.detail?.message || errorMsg;
          } catch {}
          throw new Error(errorMsg);
        }

        const audioBlob = await response.blob();

        if (audioUrl) URL.revokeObjectURL(audioUrl);

        audioUrl = URL.createObjectURL(audioBlob);
        audioPlayer.src = audioUrl;

        // Ao carregar metadados (duração etc)
        audioPlayer.onloadedmetadata = function() {
          let playbackRate = parseFloat(speedInput.value);
          const desiredDuration = parseFloat(desiredDurationInput.value);

          if (desiredDuration && desiredDuration > 1) {
            const originalDuration = audioPlayer.duration;
            let calculatedRate = originalDuration / desiredDuration;
            if (calculatedRate < 0.7) calculatedRate = 0.7;
            if (calculatedRate > 2.0) calculatedRate = 2.0;
            playbackRate = calculatedRate;
            speedInput.value = playbackRate.toFixed(2);
            speedValue.textContent = playbackRate.toFixed(2) + "x";
          }
          audioPlayer.playbackRate = playbackRate;
        };

        // Remove reverb antigo (se houver)
        removeReverb(audioPlayer);

        // Se reverb estiver ativado, aplica
        if (reverbInput.checked) {
          applyReverb(audioPlayer);
        }

        downloadBtn.href = audioUrl;
        downloadBtn.download = `lumen_audio_${Date.now()}.mp3`;
        downloadBtn.classList.remove('hidden');

        resultCard.classList.remove('hidden');
        resultCard.scrollIntoView({ behavior: 'smooth' });

        // Finaliza barra de progresso
        clearInterval(fakeProgressInterval);
        updateProgress(100);
        setTimeout(() => { progressBarContainer.classList.add('hidden'); }, 1200);

        // Mostra botões adicionais
        showEffectButtons();

      } catch (error) {
        clearInterval(fakeProgressInterval);
        updateProgress(0);
        progressBarContainer.classList.add('hidden');
        console.error('Erro na geração de áudio:', error);
        showError(`Erro: ${error.message}`);
      } finally {
        generateBtn.disabled = false;
        loadingElement.classList.add('hidden');
      }
    });

    // Baixar áudio com efeito (reverb)
    async function downloadAudioWithReverb(audioUrl, playbackRate = 1.0) {
      const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
      const response = await fetch(audioUrl);
      const arrayBuffer = await response.arrayBuffer();
      const audioBuffer = await audioCtx.decodeAudioData(arrayBuffer);

      // Carregue o impulse response (reverb)
      const irResp = await fetch('https://cdn.jsdelivr.net/gh/joeeyjunior/public-assets@main/impulse-small.wav');
      const irBuf = await irResp.arrayBuffer();
      const irBuffer = await audioCtx.decodeAudioData(irBuf);

      // Crie um OfflineAudioContext para renderizar o efeito
      const offlineCtx = new OfflineAudioContext(
        audioBuffer.numberOfChannels,
        Math.ceil(audioBuffer.length / playbackRate),
        audioBuffer.sampleRate
      );
      const source = offlineCtx.createBufferSource();
      source.buffer = audioBuffer;
      source.playbackRate.value = playbackRate;

      const convolver = offlineCtx.createConvolver();
      convolver.buffer = irBuffer;

      source.connect(convolver);
      convolver.connect(offlineCtx.destination);

      source.start(0);
      const renderedBuffer = await offlineCtx.startRendering();

      // Converta para WAV
      const wavBlob = bufferToWavBlob(renderedBuffer);

      // Crie o link de download
      const url = URL.createObjectURL(wavBlob);
      const a = document.createElement('a');
      a.href = url;
      a.download = `lumen_audio_reverb_${Date.now()}.wav`;
      document.body.appendChild(a);
      a.click();
      setTimeout(() => {
        URL.revokeObjectURL(url);
        document.body.removeChild(a);
      }, 1000);
    }

    // Função para converter AudioBuffer para WAV Blob
    function bufferToWavBlob(buffer) {
      function encodeWAV(buff) {
        const numOfChan = buff.numberOfChannels;
        const length = buff.length * numOfChan * 2 + 44;
        const bufferWav = new ArrayBuffer(length);
        const view = new DataView(bufferWav);
        let offset = 0;

        function writeString(s) {
          for (let i = 0; i < s.length; i++) view.setUint8(offset + i, s.charCodeAt(i));
          offset += s.length;
        }
        function floatTo16BitPCM(output, offset, input) {
          for (let i = 0; i < input.length; i++, offset += 2) {
            let s = Math.max(-1, Math.min(1, input[i]));
            s = s < 0 ? s * 0x8000 : s * 0x7FFF;
            output.setInt16(offset, s, true);
          }
        }
        writeString('RIFF');
        view.setUint32(offset, length - 8, true); offset += 4;
        writeString('WAVE');
        writeString('fmt ');
        view.setUint32(offset, 16, true); offset += 4;
        view.setUint16(offset, 1, true); offset += 2;
        view.setUint16(offset, numOfChan, true); offset += 2;
        view.setUint32(offset, buffer.sampleRate, true); offset += 4;
        view.setUint32(offset, buffer.sampleRate * numOfChan * 2, true); offset += 4;
        view.setUint16(offset, numOfChan * 2, true); offset += 2;
        view.setUint16(offset, 16, true); offset += 2;
        writeString('data');
        view.setUint32(offset, length - offset - 4, true); offset += 4;

        // Interleave channels
        let interleaved = new Float32Array(buff.length * numOfChan);
        for (let chan = 0; chan < numOfChan; chan++) {
          let channel = buff.getChannelData(chan);
          for (let i = 0; i < channel.length; i++) {
            interleaved[i * numOfChan + chan] = channel[i];
          }
        }
        floatTo16BitPCM(view, offset, interleaved);
        return bufferWav;
      }

      return new Blob([encodeWAV(buffer)], { type: 'audio/wav' });
    }

    downloadWithEffectBtn.onclick = function(e) {
      e.preventDefault();
      if (!audioPlayer.src) return;
      let playbackRate = parseFloat(speedInput.value);
      downloadAudioWithReverb(audioPlayer.src, playbackRate);
    };

    // Play áudio processado com efeito na página (robusto)
    let playEffectAudioContext = null;
    let playEffectSource = null;
    playWithEffectBtn.onclick = async function() {
      if (!audioPlayer.src) {
        alert("Gere o áudio primeiro.");
        return;
      }
      try {
        // Fecha contextos antigos
        if (playEffectAudioContext) {
          playEffectAudioContext.close();
          playEffectAudioContext = null;
          playEffectSource = null;
        }

        let playbackRate = parseFloat(speedInput.value);
        const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
        playEffectAudioContext = audioCtx;

        // Carregar áudio original
        const resp = await fetch(audioPlayer.src);
        if (!resp.ok) throw new Error("Erro ao carregar áudio para efeito.");
        const arrayBuffer = await resp.arrayBuffer();
        const audioBuffer = await audioCtx.decodeAudioData(arrayBuffer);

        // Carregar impulse response (reverb)
        const irResp = await fetch('https://cdn.jsdelivr.net/gh/joeeyjunior/public-assets@main/impulse-small.wav');
        if (!irResp.ok) throw new Error("Erro ao carregar impulse response.");
        const irBuf = await irResp.arrayBuffer();
        const irBuffer = await audioCtx.decodeAudioData(irBuf);

        // Cria nodes
        const source = audioCtx.createBufferSource();
        playEffectSource = source;
        source.buffer = audioBuffer;
        source.playbackRate.value = playbackRate;

        const convolver = audioCtx.createConvolver();
        convolver.buffer = irBuffer;

        source.connect(convolver);
        convolver.connect(audioCtx.destination);

        source.start(0);

        // Para o áudio se clicar novamente no botão
        source.onended = () => {
          audioCtx.close();
          playEffectAudioContext = null;
          playEffectSource = null;
        };

      } catch (e) {
        alert("Falha ao reproduzir áudio com efeito: " + e.message);
      }
    };

    function showError(message) {
      errorMessage.textContent = message;
      errorMessage.style.color = "#ff6b6b";
      errorMessage.classList.remove('hidden');
      resultCard.classList.add('hidden');
    }
  </script>
</body>
</html>
